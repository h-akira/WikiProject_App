{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
<link rel="stylesheet" href="{% static 'css/markdownRender.css' %}">
{% endblock extra_css %}

{% block title %}{{ page.title }}{% endblock title %}
{% block content %}
<div class="has-background-grey has-text-white-bis">
  <div class="padding-side padding-top-10 padding-bottom-10">
    <h1 class="title is-1 has-text-white-bis">
      {{ page.title }}
      {% if not share and not page.public %}
      <i class="bi bi-lock"></i>
      {% endif %}
    </h1>
    <p>
      (最終更新:{{ page.last_updated }})
    </p>
    <p>
    {% if page.share %}
    {% if share %}
    <span hidden>
    {% endif %}
    <a id="share-link" href="{% url 'wiki:share_detail' share_code %}" class="button is-light is-link">
      共有ページ
    </a>
    {% if share %}
    </span>
    {% endif %}
    <button id="copy-button" class="button is-info is-light">
      共有URLをコピー
    </button>
    {% endif %}
    {% if not share and edit %}
    <a href="{% url 'wiki:update' username slug %}" class="button is-light">
      編集
      {% if not page.edit_permission %}
      <i class="bi bi-lock"></i>
      {% endif %}
    </a>
    {% endif %}
    {% if share and page.share_edit_permission %}
    <a href="{% url 'wiki:share_update' share_code %}" class="button is-light">
      編集
    </a>
    {% endif %}
    </p>
  </div>
</div>
<div class="padding-side content">
  <div id="preview"></div>
  <textarea id="id_text" style="display: none;">{{ page.text }}</textarea>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/clip.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configure marked options
    marked.setOptions({
      breaks: true,
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(code, { language: lang }).value;
          } catch (err) {}
        }
        return hljs.highlightAuto(code).value;
      }
    });

    // Render markdown
    const textarea = document.getElementById('id_text');
    const preview = document.getElementById('preview');
    if (textarea && preview) {
      const markdown = textarea.value;
      preview.innerHTML = marked.parse(markdown);

      // Apply syntax highlighting to code blocks
      preview.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    }
  });
</script>
{% endblock extra_js %}
